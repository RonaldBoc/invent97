<% const formatDate = (value) => {
     if (!value || typeof value !== 'string') {
       return '—';
     }
     const trimmed = value.trim();
     if (!trimmed) {
       return '—';
     }
     if (/^\d{4}-\d{2}-\d{2}$/.test(trimmed)) {
       const [year, month, day] = trimmed.split('-');
       return `${day}/${month}/${year}`;
     }
     return trimmed;
   };
   const resolveTerritoireLabel = (territoire) => {
     if (territoire === 'martinique') return 'Martinique';
     if (territoire === 'guadeloupe') return 'Guadeloupe';
     return 'Territoire non renseigné';
   };
   const territoryLabel = resolveTerritoireLabel(employe.territoire);
   const contactEmail = typeof employe.email === 'string' && employe.email.trim().length ? employe.email.trim() : null;
   const contactPhone = typeof employe.telephone === 'string' && employe.telephone.trim().length ? employe.telephone.trim() : null;
   const jobTitle = typeof employe.poste === 'string' && employe.poste.trim().length ? employe.poste.trim() : null;
   const noteContent = typeof employe.commentaire === 'string' && employe.commentaire.trim().length ? employe.commentaire.trim() : null;
   const badgeDefault = { background: 'bg-slate-100', text: 'text-slate-700' };
   const stateEntries = Object.entries((assignmentStats && assignmentStats.byState) || {})
     .sort((a, b) => b[1] - a[1]);
   const hasEquipements = Array.isArray(equipements) && equipements.length > 0;
   const detailTitle = employe.nom_complet && employe.nom_complet.trim().length ? employe.nom_complet.trim() : `Employé #${employe.id}`;
%>
<div class="flex flex-col gap-6">
  <div>
    <a href="/employes" class="text-sm text-indigo-600 hover:text-indigo-700">← Retour à la liste des employés</a>
  </div>

  <% if (successMessage) { %>
    <div class="rounded-md border border-emerald-300 bg-emerald-50 px-4 py-3 text-sm text-emerald-700">
      <%= successMessage %>
    </div>
  <% } %>
  <% if (errorMessage) { %>
    <div class="rounded-md border border-rose-300 bg-rose-50 px-4 py-3 text-sm text-rose-700">
      <%= errorMessage %>
    </div>
  <% } %>

  <section class="rounded-lg border border-slate-200 bg-white p-6 shadow-sm">
    <div class="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
      <div class="flex flex-col gap-2">
        <h1 class="text-2xl font-semibold text-slate-900">Fiche collaborateur · <span class="text-indigo-600"><%= detailTitle %></span></h1>
        <p class="text-sm text-slate-600">Informations principales et matériel associé pour ce collaborateur.</p>
      </div>
      <div class="flex flex-wrap gap-2">
        <span class="inline-flex items-center rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-700"><%= territoryLabel %></span>
        <a
          href="/employes/modifier/<%= employe.id %>"
          class="inline-flex items-center justify-center rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-700"
        >
          Modifier
        </a>
      </div>
    </div>

    <dl class="mt-6 grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
      <div class="rounded-md border border-slate-100 bg-slate-50 px-4 py-3">
        <dt class="text-xs uppercase tracking-wide text-slate-500">Poste</dt>
        <dd class="mt-1 text-sm font-medium text-slate-900"><%= jobTitle || 'Non renseigné' %></dd>
      </div>
      <div class="rounded-md border border-slate-100 bg-slate-50 px-4 py-3">
        <dt class="text-xs uppercase tracking-wide text-slate-500">Adresse e-mail</dt>
        <dd class="mt-1 text-sm font-medium text-slate-900">
          <% if (contactEmail) { %>
            <a href="mailto:<%= contactEmail %>" class="text-indigo-600 hover:text-indigo-700"><%= contactEmail %></a>
          <% } else { %>
            <span class="text-slate-400">Non renseignée</span>
          <% } %>
        </dd>
      </div>
      <div class="rounded-md border border-slate-100 bg-slate-50 px-4 py-3">
        <dt class="text-xs uppercase tracking-wide text-slate-500">Téléphone</dt>
        <dd class="mt-1 text-sm font-medium text-slate-900">
          <% if (contactPhone) { %>
            <a href="tel:<%= contactPhone %>" class="text-slate-900 hover:text-indigo-600"><%= contactPhone %></a>
          <% } else { %>
            <span class="text-slate-400">Non renseigné</span>
          <% } %>
        </dd>
      </div>
      <div class="rounded-md border border-slate-100 bg-slate-50 px-4 py-3">
        <dt class="text-xs uppercase tracking-wide text-slate-500">Équipements attribués</dt>
        <dd class="mt-1 text-sm font-medium text-slate-900">
          <% if (assignmentStats && assignmentStats.total > 0) { %>
            <span class="text-base font-semibold text-slate-900"><%= assignmentStats.total %></span>
            <span class="ml-1 text-sm text-slate-500">matériel<%= assignmentStats.total > 1 ? 's' : '' %></span>
            <% if (stateEntries.length) { %>
              <div class="mt-3 flex flex-wrap gap-2">
                <% stateEntries.forEach(([stateLabel, count]) => { %>
                  <% const theme = stateBadgeTheme && stateBadgeTheme[stateLabel] ? stateBadgeTheme[stateLabel] : badgeDefault; %>
                  <span class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold <%= theme.background %> <%= theme.text %>">
                    <span><%= stateLabel %></span>
                    <span class="ml-1 text-[11px] font-medium">× <%= count %></span>
                  </span>
                <% }); %>
              </div>
            <% } %>
          <% } else { %>
            <span class="text-slate-400">Aucun matériel attribué</span>
          <% } %>
        </dd>
      </div>
      <div class="rounded-md border border-slate-100 bg-slate-50 px-4 py-3">
        <dt class="text-xs uppercase tracking-wide text-slate-500">Créé le</dt>
        <dd class="mt-1 text-sm font-medium text-slate-900"><%= formatDate(employe.date_creation) %></dd>
      </div>
      <div class="rounded-md border border-slate-100 bg-slate-50 px-4 py-3">
        <dt class="text-xs uppercase tracking-wide text-slate-500">Dernière mise à jour</dt>
        <dd class="mt-1 text-sm font-medium text-slate-900"><%= formatDate(employe.date_modification) %></dd>
      </div>
    </dl>

    <div class="mt-6 rounded-md border border-slate-100 bg-slate-50 px-4 py-3">
      <h2 class="text-xs uppercase tracking-wide text-slate-500">Notes internes</h2>
      <p class="mt-2 text-sm text-slate-700">
        <% if (noteContent) { %>
          <%= noteContent %>
        <% } else { %>
          <span class="text-slate-400">Aucune note enregistrée.</span>
        <% } %>
      </p>
    </div>
  </section>

  <section class="rounded-lg border border-slate-200 bg-white p-6 shadow-sm">
    <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
      <div>
        <h2 class="text-lg font-semibold text-slate-900">Matériel attribué</h2>
        <p class="text-sm text-slate-600">Liste des équipements actuellement associés à ce collaborateur.</p>
      </div>
      <div class="flex flex-col gap-2 sm:flex-row sm:items-center gap-3">
        <% if (assignmentStats && assignmentStats.total > 0) { %>
          <span class="inline-flex items-center rounded-full bg-indigo-50 px-3 py-1 text-xs font-semibold text-indigo-700">
            Total : <span class="ml-1"><%= assignmentStats.total %></span>
          </span>
        <% } %>
        <a
          href="/ajouter?employe_id=<%= employe.id %>"
          class="inline-flex items-center justify-center rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-700 gap-2"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          Ajouter du matériel
        </a>
      </div>
    </div>

    <% if (!hasEquipements) { %>
      <div class="mt-6 rounded-lg border border-dashed border-slate-300 bg-slate-50 p-8 text-center text-sm text-slate-500">
        Ce collaborateur n'a actuellement aucun matériel attribué.
      </div>
    <% } else { %>
      <div class="mt-6 overflow-x-auto rounded-lg border border-slate-200">
        <table class="min-w-full divide-y divide-slate-200 text-sm">
          <thead class="bg-slate-50">
            <tr>
              <th class="px-4 py-3 text-left font-semibold text-slate-600">Équipement</th>
              <th class="px-4 py-3 text-left font-semibold text-slate-600">Référence</th>
              <th class="px-4 py-3 text-left font-semibold text-slate-600">Numéro de série</th>
              <th class="px-4 py-3 text-left font-semibold text-slate-600">État</th>
              <th class="px-4 py-3 text-left font-semibold text-slate-600">Date d'achat</th>
              <th class="px-4 py-3 text-right font-semibold text-slate-600">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100">
            <% equipements.forEach((item) => { %>
              <% const itemStateTheme = stateBadgeTheme && stateBadgeTheme[item.etat] ? stateBadgeTheme[item.etat] : badgeDefault; %>
              <tr class="hover:bg-slate-50">
                <td class="px-4 py-3">
                  <div class="font-medium text-slate-900"><%= item.type_nom_final || item.type || 'Équipement' %></div>
                  <% if (item.commentaire) { %>
                    <p class="mt-1 text-xs text-slate-500"><%= item.commentaire %></p>
                  <% } %>
                </td>
                <td class="px-4 py-3 text-slate-700">
                  <% const labelParts = [];
                     if (item.marque) labelParts.push(item.marque);
                     if (item.modele) labelParts.push(item.modele);
                  %>
                  <%= labelParts.length ? labelParts.join(' · ') : '—' %>
                </td>
                <td class="px-4 py-3 font-mono text-xs text-slate-700">
                  <%= item.numero_serie && item.numero_serie.trim().length ? item.numero_serie : '—' %>
                </td>
                <td class="px-4 py-3">
                  <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold <%= itemStateTheme.background %> <%= itemStateTheme.text %>"><%= item.etat || 'Inconnu' %></span>
                </td>
                <td class="px-4 py-3 text-slate-700"><%= formatDate(item.date_achat) %></td>
                <td class="px-4 py-3 text-right">
                  <a
                    href="/equipements/<%= item.id %>"
                    class="inline-flex items-center rounded-md border border-indigo-200 px-3 py-1 text-xs font-medium text-indigo-700 hover:bg-indigo-50"
                  >
                    Voir
                  </a>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
    <% } %>
  </section>
</div>
